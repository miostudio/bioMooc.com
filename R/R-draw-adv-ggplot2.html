<!Doctype html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>R 教程 | 生物慕课网</title>

<link rel="canonical" href="http://www.biomooc.com/R/R-tutorial.html" />
<meta name="keywords" content="R 绘图教程,ggplot2">
<meta name="description" content="R 绘图教程,ggplot2。">
		
	<link rel="shortcut icon" href="/img/favicon.ico" mce_href="/img/favicon.ico" type="image/x-icon" >
	<link rel="stylesheet" href="/wp-content/themes/biomooc/style.css?v=1.141" type="text/css" media="all" />	
	<link rel="stylesheet" href="/static/css/font-awesome.min.css" media="all" />	
<!--
	<link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" media="all" />	  
-->
  <!--[if gte IE 9]><!-->
  <script src="/static/js/jquery.min.js"></script>
  <!--<![endif]-->
  <!--[if lt IE 9]>
     <script src="//cdn.bootcss.com/jquery/1.9.1/jquery.min.js"></script>
     <script src="//cdn.bootcss.com/html5shiv/r29/html5.min.js"></script>
  <![endif]-->
  <link rel="apple-touch-icon" href="/img/mobile-icon.png"/>
  <meta name="apple-mobile-web-app-title" content="生物慕课网">

</head>


<body>
<!-- 头尾自动加载 -->
<script>
$(function(){
	$.get('/part/header-nav.html',function(data,status){
		$('body').prepend(data);//header-nav
	});
	
	$('<div id="footer" class="mar-t50"></div>').appendTo($("body"));
	$("#footer").load("/part/footer.html"); //footer
	
	$.get('/part/right-bottom-btn.html',function(data,status){
		$('#footer').after(data);//右下角按钮
	});

	
			
	//左右菜单
	$.get('./part/menu-left.html',function(data,status){
		$('.main .row').first().prepend(data);//左侧菜单-本文件夹内使用
	});
	
	$.get('/part/menu-right.html',function(data,status){
		$('.main .row').first().append(data);//右侧菜单-全局通用
		//没有事件，还需要绑定事件
		
		
	});
	
	$.getScript("/wp-content/themes/biomooc/assets/js/main.js?v=1.15");//回到顶部js文件
});
</script>

<style>
/*本页R代码过长: 最长n px,超过了出现滚动条*/
.notranslate{max-height:400px; overflow:scroll;}

h4{
	margin-top: 30px;
    border-left: 3px solid red;
    padding-left: 2px;
}
</style>
	
	

<!--  内容  -->
<div class="container main">
	<!-- 中间 -->
	<div class="row">
	





<div class="col middle-column">
		
	
	<div class="article">
			<div class="article-heading-ad" style="display: none;">
		
		</div>
		<div class="previous-next-links">
			<div class="previous-design-link"><i style="font-size:16px;" class="fa fa-arrow-left" aria-hidden="true"></i> <a href="/R/R-intro.html" rel="pre">R 简介</a> </div>
			<div class="next-design-link"><a href="/R/R-intro.html" rel="next"> R 简介</a> <i style="font-size:16px;" class="fa fa-arrow-right" aria-hidden="true"></i></div>
		</div>
		<div class="article-body">
		
			<div class="article-intro" id="content">
			
			<h1><span class="color_h1">R绘图 </span> 使用ggplot2进行高级绘图</h1>



<h2 class="tutheader">目录</h2>
<p><b>要点</b>: lattice和ggplot2包极大地扩展了R绘图的范畴，提高了图形的质量。[R In Action(2nd Edition), Chapter19]</p>

<ul>
	<li><a href="#1">ggplot2包介绍</a>
	<li><a href="#2">用几何函数指定图的类型
		<ul>
			<li><a href="#2_1">批量小提琴图</a>
			<li><a href="#2_2">概率密度曲线和频率分布直方图</a>
			<li><a href="#6_2">饼图（原生R和ggplot2）</a>
		</ul>
	</a>
	<li><a href="#3">分组</a>
	<li><a href="#4">分面: 一维facet_wrap(~x)，二维facet_grid(x~y)</a>
	
	<li><a href="#42">位置调整(position="dodge|fill|stack|identity|jitter")</a>
	
	<li><a href="#5">添加光滑曲线</a>
	<li><a href="#6">修改ggplot2图形的外观</a>
		<ul>
			<li><a href="#6_1">坐标轴 todo</a>
				<ul>
					<li><a href="#6_1_1">hjust和vjust</a></li>
				</ul>
			</li>
			
			<li><a href="#6_2">图例(legend): 饼图</a></li>
			<li><a href="#6_3">标度(scale) todo</a></li>
			<li><a href="#6_4">主题(theme) </a></li>
			<li><a href="#6_5">多重图，一页多图</a></li>
		</ul>
	</li>
	<li><a href="#7">保存图片</a></li>
	<li><a href="#8">添加文字</a></li>
	<li><a href="#100">深入学习 ggplot2</a></li>
</ul>






<p>R作图的目的：更好地理解数据，并能够与他人沟通这些理解方式。</p>

<a name="1"></a>
<h2 class="tutheader">ggplot2 包简介</h2>
<p><a target="_blank" href="https://ggplot2.tidyverse.org/reference/">官网 reference</a> 应该是你入门后参考最多的网站。其次是应该打印出来贴墙上的小抄 <a target="_blank" href=" https://www.rstudio.com/wp-content/uploads/2015/03/ggplot2-cheatsheet.pdf">ggplot2-cheatsheet.pdf</a>。</p>


<p>知名图书： <a target="_blank" href="http://www.cookbook-r.com/Graphs/">《R cookbook》</a>, <a target="_blank" href="https://r4ds.had.co.nz/data-visualisation.html">《R for Data Science》</a>,  <a target="_blank" href="https://ggplot2-book.org/">《ggplot2: Elegant Graphics for Data Analysis》</a>,  </p>
<p>甚至有人写了 <a target="_blank" href="http://ggplot.yhathq.com/">python版的ggplot包</a>。 </p>
<br>
<p><b><a target="_blank" href="https://tool.biomooc.com/R_scripts/">专题：ggplot2画paper中常见的图</a></b></p>
<hr>





<a name="2"></a>



<a name="2_1"></a>
<h3 class="tutheader">批量小提琴图</h3>
<p>目标: <a target="_blank" href="https://www.nature.com/articles/nature24489">Adam et al, Nature 2017 Fig3 c</a></p>
<img src="images/draw-adv-ggplot2/violins_normal.png">
<img src="images/draw-adv-ggplot2/violins_horizon.png">

<div class="code notranslate">
	<div style="white-space: pre-wrap;">#数据为scRNAseq表达量，想看若干基因在不同cluster内的表达情况:
> head(df) #5万行， 3列
     seurat_clusters variable     value
1480               2    PTPRC 0.0000000
1483               2    PTPRC 0.3043327

> table(df$seurat_clusters)
     1      2      3      4 
152076 141873 122417 115729 

> table(df$variable)
    CCR7     CD34     CD3D      CD4     CD68    CD79A     CD8A   COL1A1    CSF1R    CSF3R    EPCAM     FPR1 
   28005    28005    28005    28005    28005    28005    28005    28005    28005    28005    28005    28005 
    GZMA      LYZ    MS4A1    PTPRC   S100A9 TNFRSF17   TPSAB1 
   28005    28005    28005    28005    28005    28005    28005
#

#1. 正常小提琴图
df$seurat_clusters=as.factor(df$seurat_clusters) #一定要注意，分类变量必须是因子！大坑！！
str(df)

p = ggplot(df,aes(x=variable,y=value,fill=variable))+
  geom_violin(scale = "width",colour="white") + #小提琴图，边框颜色白色，fill属性为填充颜色
  facet_wrap(seurat_clusters~ . ,strip.position = "left",ncol = 1) + #分面，多行
  theme_bw() + #白主题
  theme(panel.grid = element_blank(), #不要背景
        axis.ticks.y=element_blank(), #不要y坐标刻度
        
        axis.text.x = element_text(angle=45,vjust=1,hjust = 1), #x文字倾斜45度
        axis.text.y = element_blank(), #不要y轴文字
        
        legend.position = "none", #不要图例
        
        panel.spacing=unit(0,"cm"), #分面间距为0
        
        strip.text.y = element_text(angle = 180),
        strip.background = element_blank()) 
print(p)


#2. 旋转小提琴图
p2 = ggplot(df,aes(x=seurat_clusters,y=value,fill=variable))+
  geom_violin(scale = "width",colour="white",alpha=0.85,width=1) +
  coord_flip() + #guides(fill=FALSE)
  facet_wrap(variable~.,nrow = 1, strip.position = "bottom") + 
  theme_bw() +
  theme(
        panel.grid = element_blank(), #不要背景网格
        axis.text.x = element_blank(), #不要x坐标轴刻度文字
		
        axis.text.y = element_text(size=15), #y坐标刻度字号
        axis.title.y = element_text(size=15), #y标题字号
        
        legend.position = "none", #不要图例
        panel.spacing=unit(0,"cm"), #分面的间距
    
        strip.placement = "outside", #分面标签位置
        strip.text.x = element_text(angle=90,vjust=1,hjust = 1,size=15), #分面标签 文字倾斜; 字号
        strip.background = element_blank() #分面标签 不要背景
    )
print(p2)</div>
</div>
<br><br>













<a name="2_2"></a>
<h3 class="tutheader">概率密度曲线图，频率分布直方图</h3>
<img src="images/draw-adv-ggplot2/geom_density1.png">
<img src="images/draw-adv-ggplot2/geom_density2.png">
<div class="code notranslate">
	<div style="white-space: pre-wrap;"># 例1 概率密度曲线
ggplot(iris, aes(x = Sepal.Length)) + theme_bw()+
  geom_density(aes(color = Species))


# 例2 画频率分布图，使用 y=..density..
df=data.frame(
  cid=seq(1,22),
  group=c(rep("A",7), rep("B",15) ),
  num=c(0.3,0.16, 0.1, 0.2, 0.3, 0.4, 0.1, 0.1, 0.1, 0.2, 0.1, 0.1, 
        0.1, 0.2, 0.3, 0.4, 0.5,0.1,  0.1, 0.2, 0.2, 0.1 )
) # 两组数据(编号1,2)，每组污染指数
head(df)
#df$group=factor(df$group,levels=c('B','A'))
df$group=factor(df$group,levels=c('A','B'))
# 使用ggplot2 画频率分布直方图，和概率密度曲线
library(ggplot2)
ggplot(df,aes(x=num,y=..density..,fill=group))+
  geom_histogram(position = "dodge",binwidth = 0.1)+ #画线
  geom_text(aes(label=round(..density..,1)),position = "dodge",
            stat="bin",binwidth = 0.1,vjust=-0.3)+ #曲线上数字是高度，是频数/总数/组距
  geom_line(stat="density", aes(color=group))+ #只有线条
  #geom_density( aes(color=group), alpha=0.5)+ #曲线下面积是1,带阴影，带边框
  scale_color_manual(values=c('red','green'))+
  theme_bw()#+
  xlim(-0.1,0.6) #显示概率密度曲线两端

# 每组频率=频数/总和
table(df$group)
# A  B
# 7  15
#
summary(df$num)
#Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#0.100   0.100   0.150   0.195   0.225   0.500
#
df[which(df$group=='A'),]$num
df[which(df$group=='B'),]$num
# 第一个bin总是 [min, min + binwidth/2)，之后开始正常
nrow(df[which(df$num >= 0.1 & df$num<0.15 & df$group=="A"),])/7/0.1; #4
nrow(df[which(df$num >= 0.1 & df$num<0.15 & df$group=="B"),])/15/0.1; #5.3
#
nrow(df[which(df$num >= 0.15 & df$num<0.25 & df$group=="A"),])/7/0.1; #2.8
nrow(df[which(df$num >= 0.15 & df$num<0.25 & df$group=="B"),])/15/0.1; #2.7
# 
# ...
#
## R原生绘图函数 A 一致
hist( df$num[which(df$group=='A')], n=20 )
plot( density(df$num[which(df$group=='A')], n=100) )
#plot( density(df$num[which(df$group=='A')]), xlim=c(0.1,0.5), ylim=c(0,6) )

# R原生绘图函数 B 一致
hist( df$num[which(df$group=='B')], n=20 )
plot( density(df$num[which(df$group=='B')]) )

# 查看A的值
df$num[which(df$group=='A')]
table(df$num[which(df$group=='A')])

# 查看B的值
df$num[which(df$group=='B')]
table(df$num[which(df$group=='B')])
# ggplot2 v3.2.1</div>
</div>
<br>




<h3>频率分布直方图(使用breaks参数，设置分段点)</h3>
<img src="images/draw-adv-ggplot2/geom_hist.png">
<div class="code notranslate">
	<div style="white-space: pre-wrap;">score=c(122,134,179,118,90,290,235,356,401,404,407,410,
        413,416,419,422,425,428,431,434,437, 750)
hist(score, breaks=c(0,199.5,399.5,599.5, 799.5))

library(ggplot2)
#使用频数
g1=ggplot(NULL, aes(x=score, y=..count..))+theme_classic()+
  geom_histogram(fill="#E5522C", breaks = c(0,199.5,399.5,599.5,799.5))
#使用频率
g2=ggplot(NULL, aes(x=score, y=..count../sum(..count..)*100 ))+theme_classic()+
  geom_histogram(fill="#244264", breaks = c(0, seq(199.5,799.5,200) )  )+
  labs(y="Frequency(%)")
library(gridExtra)
grid.arrange(g1,g2,nrow=2)</div>
</div>
<br><br>












<a name="3"></a>
<h2 class="tutheader">分组</h2>
<p>under coding ...</p>










<a name="4"></a>
<h2 class="tutheader">分面: 一维facet_wrap(~x)，二维facet_grid(x~y)</h2>
<p>ggplot2提供了2种分面系统，根据需要选择.</p>
<img src="images/draw-adv-ggplot2/facet.png">

<div class="code notranslate">
	<div style="white-space: pre-wrap;">library(ggplot2)
dim(mpg) #234  11
str(mpg)
head(mpg)
#  manufacturer model displ  year   cyl trans      drv     cty   hwy fl    class  
#<chr>        <chr> <dbl> <int> <int> <chr>      <chr> <int> <int> <chr> <chr>  
#1 audi         a4      1.8  1999     4 auto(l5)   f        18    29 p     compact
#2 audi         a4      1.8  1999     4 manual(m5) f        21    29 p     compact
table(mpg$drv)
#取子集: 三种气缸cyl(4,6,8),2种驱动轮drv(4,f)
mpg2=subset(mpg, cyl != 5 & drv %in% c('4','f') ) #todo 值得学习
dim(mpg2) #205  11
#
# 画图
# x:city miles per gallon;  每加仑城市英里数;
# y:highway miles per gallon 每加仑高速英里数；
g=ggplot(mpg2, aes(cty, hwy))+geom_point()
g

#1.封装分面: 先搞一个长队列，再根据行列设置断开
g+facet_wrap(~cyl, nrow=2) #指定2行。如果设置nrow=1，则图和facet_grid(.~cyl)效果一致;
g+facet_wrap(~cyl, ncol=2) #指定2列，和上一行效果一样。

#2.网格分面
#(1)加入第1个分类变量: 气缸数number of cylinders
g+facet_grid(.~cyl) #一行 3列 (这个目测效果更好，感觉八缸被蹂躏了) #见上图
g+facet_grid(cyl~.) #3行，一列

#看直方图更明显: 每个图的最高峰比较，4气缸每加仑油在城市跑得最远
ggplot(mpg2, aes(cty))+geom_histogram(binwidth=2)+
  facet_grid(cyl~.)
#

#(2)加入第2个分类变量: 驱动方式。得到二维分面
g+facet_grid(drv~cyl) #二维的驱动轮越多
g+facet_grid(drv~cyl, margins=T) #添加边际图(相当于行列小计)

# 每个纯度分面下，不同切割的价格密度曲线。见下图
ggplot(diamonds, aes(x=price, fill=cut)) +
  geom_density(alpha=0.25) +
  facet_wrap(~clarity, nrow=1)+
  theme_bw() #简化主题</div>
</div>
<img src="images/draw-adv-ggplot2/facet_wrap.png">
<br><br>








<a name="42"></a>
<h2 class="tutheader">位置调整(position="dodge|fill|stack|identity|jitter")</h2>
<p>position参数: R in action,P62. jitter对散点图有效，对柱状图虽然能画出来，但是没有意义。</p>
<p>基于table()统计结果的 <a target="_blank" href="https://tool.biomooc.com/R_scripts/#t6">barplot 百分数堆叠条形图(原生+ggplot2)</a>。</p>
<img src="images/draw-adv-ggplot2/position.png">

<div class="code notranslate">
	<div style="white-space: pre-wrap;">library(ggplot2)
dim(diamonds) #[1] 53940    10
df=diamonds[1:10000, c('clarity', 'cut')]
dim(df) #[1] 10000     2
str(df) #一行是一个钻石，包括2个属性: 纯度、切割好坏; 都是因子型的分类变量;
head(df)
#  clarity cut 
#<ord>   <ord>    
#1 SI2     Ideal    
#2 SI1     Premium  
#3 VS1     Good     
#4 VS2     Premium  
#5 SI2     Good     
#6 VVS2    Very Good
# 定义绘图函数，方便复用
draw1=function(position){
  alpha=1; if(position=="identity"){alpha=0.8;}
  #
  print( paste(position,'; alpha=', alpha) )
  ggplot(df, aes(clarity, fill=cut))+
    #factor(cut,levels = c("Good","Ideal","Fair", "Very Good","Premium")) #改变图例的顺序
    geom_histogram(stat="count", position=position, alpha=alpha)+
    theme_classic()+#简化背景
    theme(axis.text.x=element_text(angle=60, hjust=1,size=8,color="blue") )+ #坐标轴文字旋转60度。
    scale_fill_discrete('Cut')+ #指定图例标题
    labs(title= paste0("position=",position) ) #顶部标题
}
g1=draw1('stack'); #将图形元素堆叠起来
g2=draw1('fill') #同stack堆叠图形，并标准化高度到1
g3=draw1('dodge');g3 #避免重叠，并排放置(类似分面)
g4=draw1('identity') #不做任何调整。互相遮挡，效果不好。

#
g5=ggplot(df, aes(clarity, color=cut))+
  geom_line(stat="count", aes(y=..count.., group=cut) )+
  theme_classic()+#简化背景
  theme(axis.text.x=element_text(angle=60, hjust=1,size=8,color="blue") )+
  scale_fill_discrete('Cut')+ #指定图例标题
  labs(title= "geom_line" )

# 保存pdf到硬盘
library(Cairo)
library(gridExtra) #一页多图
#
CairoPDF(file="position.pdf", width=10, height=6)
grid.arrange(g1,g2,g3,g4,g5,nrow=2)
dev.off();</div>
</div>
<br><br>












<a name="6"></a>
<h2 class="tutheader">修改ggplot2图形的外观</h2>

<a name="6_1"></a>
<h3 class="tutheader">坐标轴</h3>

<a name="6_1_1"></a>
<h3 class="tutheader">hjust和vjust</h3>
<img src="images/draw-adv-ggplot2/hjust_vjust.png"><br><br>
<p>hjust 控制水平对齐和 vjust 控制垂直对齐。</p>
<p>取值[0,1]之间, 0表示左对齐, 1表示右对齐</p><br>
<div class="code notranslate">
	<div style="white-space: pre-wrap;">td=expand.grid(
  hjust = c(0,0.5,1),
  vjust = c(0,0.5,1),
  angle = c(0,45,90),
  text =c('Text')
)
td
ggplot(td,aes(x = hjust,y = vjust))+ 
  geom_point()+ #theme_bw()+
  geom_text(aes(label = text,angle = angle,hjust = hjust,vjust = vjust))+ 
  facet_grid(angle~.)+ 
  scale_x_continuous(breaks = c(0,0.5,1),expand = c(0,0.2))+ 
  scale_y_continuous(breaks = c(0,0.5,1),expand = c(0,0.2))</div>
</div>
<br><br>








<a name="6_2"></a>
<h3 class="tutheader">饼图，ggplot2 theme和legend的修改</h3>
<p>注意：分类变量一定要手动转为因子，自动转换的很可能不是预期的顺序。 df$xx=factor(df$xx, levels=('z1', 'a2', 'd3'))</p>
<p>目标: <a target="_blank" href="https://academic.oup.com/nar/article/47/19/10027/5566587">Eldad et al, nar 2019, Fig3C</a></p>
<p><a target="_blank" href="https://rkabacoff.github.io/datavis/modifyingthemes.pdf">modifyingThemes.pdf</a></p>
<img src="images/draw-adv-ggplot2/pie_ggplot2.png">
<div class="code notranslate">
	<div style="white-space: pre-wrap;">########### 画饼图
#数据
x=c(40,20,3,26,10,45)
x2=c('z1','d2','n3','b4','a5','c6')
x3=paste0(x2, "(",x,', ',round(x/sum(x)*100,2),"%)" );x3
x4=(paste0(x, "\n",round(x/sum(x)*100,2),"%" ) );x4
###################
# 原生R函数 画饼图
pie(x)
pie(x,labels=x3) #加上百分比

pie(x,labels=x3,edges = 20) #最外圈的多边形的边的个数(默认200)
pie(x,labels=x3,radius = 0.5) #圈是画在一个正方形内的[0,1](默认0.8)

pie(x,labels=x3,clockwise=T) #顺时针开始画

#lty : 每个扇区的线型（0：无，1：实线；2：短划线；3：点线；4：点划线；5：长划线；6：双划线;）
pie(x,labels=x3,clockwise=T, lty =0)
pie(x,labels=x3,clockwise=T, lty =0:5)

#border : 每个扇区的边框颜色。
pie(x,labels=x3,clockwise=T, border ="red")
pie(x,labels=x3,clockwise=T, border =c(1:6))


#自定义颜色
library(RColorBrewer)
#brewer.pal.info # 查看有哪些调色板
col6=RColorBrewer::brewer.pal(n = 6,name = "Set2")
barplot(c(1:6),col=col6) #预览颜色
#
pie(x,labels=x3,clockwise=T, col=col6)  


#想要图例横着排序，只能提前对图例排序
# https://stackoverflow.com/questions/39552682/base-r-horizontal-legend-with-multiple-rows/39552713
Nfact = 6
Nrows = 2
Ncols = ceiling(Nfact / Nrows)
MyOrder = matrix(1:(Nrows*Ncols), nrow=Nrows, ncol=Ncols, byrow=T)


#fig1
pie(x, #数据
    labels=x4, #标签
    clockwise=T, #顺时针方向
    col=col6, #扇形颜色
    main="Pie Plot of XX",
    lty=0) #扇形描边，去掉
#legend(x=-1,y=-1.2, #"right", #图例位置
legend("bottom", 
       inset=-0.2, #图例为关键词时，inset = 分数 设置其相对位置(-向下，+向上)
       legend=x2[MyOrder], #图例文字
       fill=col6[MyOrder], #图例填充颜色
       
       #box.lty=1, #图例最外大方框
       bty="n", #不要图例边框
       
       #title.adj=0, #图例标题的相对位置，0.5为默认，在中间。0最左，1为最右。
       #title="Type",#图例标题
       
       cex=1, #字体大小倍数
       #horiz = T,#横着显示，会覆盖掉ncol
       ncol=3, #图例显示为n列
       #byrow=T, #??
       
       xpd=T, #有这句话才能显示在图外
       x.intersp=0.5, #图例中文字离图片的水平距离
       #y.intersp=1, #图例中文字离图片的垂直距离
       
       text.width=0.3, #两个图例之间的距离
       #merge = TRUE,
       #title="Type", #图例标题
       border=NA #不要图例小方块描边
)
#



###################
## 使用ggplot2包 画饼图
df=data.frame(
  count=x, #计数
  type=x2, #右侧图例的颜色
  #tag=x3, #饼图上的图注
  tag=x4
)
head(df)

# 去掉背景
library(ggplot2)
blank_theme = theme_minimal()+
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    panel.border = element_blank(),
    panel.grid=element_blank(),
    axis.ticks = element_blank(),
    plot.title=element_text(size=14, face="bold",
                            hjust = 0.5)#大图标题居中
  )

library(ggrepel) #geom_text_repel 比 geom_text新增功能：防止文字遮挡，自动连线点和标签
ggPie=function(df2){
  #df=df2
  g=ggplot(df2, mapping=aes(x="", y=count,fill=type))+
    geom_bar(stat="identity",width=0.5)+
    #coord_polar("y", start=0)+ #0度角起始角度
    coord_polar(theta = 'y', direction = -1)+ #direction设置方向
    #scale_fill_manual(values=col6)
    scale_fill_brewer(palette="Dark2")+
    blank_theme+
    theme(legend.position="bottom", #图例显示位置
          
          legend.margin=margin(t = -1.5, unit='line'), #图例整体上边距,缩减n行
          
          legend.spacing.x = unit(2, 'pt'), #图例之间的x距离
          legend.spacing.y = unit(2,"pt"), #图例之间的y距离
          
          #plot.margin=unit(c(1,0,1,0),"lines"), #图形外围边框top,right,bottom,left
          
          
          legend.box = "horizontal", #多图排列方式 'horizontal', 'vertical'
          #legend.direction="horizontal", #图例排列方向 'horizontal', 'vertical'
          #legend.title.align = 0.5, #？
          #legend.key = element_rect(color = NA, fill = NA), #图例每个方块的边框
          #legend.key = element_rect(size = 1,color = 'yellow' ),
          
          #legend.key.size = unit(0.2, "cm"), #图例方块大小
          legend.key.height=unit(1,"line"), #图例方块的高度
          legend.key.width=unit(0.5,"line"), #图例方块的宽度度
          
          #标签right距离，left距离
          legend.text = element_text(margin = margin(r = 20, l=2,t = -3, unit = "pt")), 
          #legend.text = element_text(margin = margin(t = -5,unit='pt')), #图例文字上移-n,或下移n
          
          
          
          legend.background = element_blank() )+  #去掉图例背景
    #guides(fill = guide_legend(title = NULL))+ #去掉图例标题
    guides(fill = guide_legend(ncol = 3, #图例几列
                               inset=-0.5,
                               byrow=T))+ #图例横着排？默认竖着排
    labs(title="Pie plot (ggplot2)",  #设置大图标题
         #subtitle ="subtitles here, pie from count data.",
         x="",y="")+
    geom_text_repel(stat="identity",aes(x=1.2,y=x, label = tag), size=4, #饼图上的文字
              position=position_stack(vjust = 0.5));g
  #geom_text(stat="identity",aes(y=x, label = scales::percent(x/100)), 
  #          size=4, position=position_stack(vjust = 0.5))
  return(g)
}

#1 ggplot2 图例距离怎么调?
# https://stackoverflow.com/questions/11366964/is-there-a-way-to-change-the-spacing-between-legend-items-in-ggplot2
#2 ggplot2 主题（theme）设置 
# http://www.sohu.com/a/224303554_466874
# https://www.sohu.com/a/135157372_572440
# https://stackoverflow.com/questions/17073772/ggplot2-legend-on-top-and-margin


#分类变量一定要是因子才行，否则顺序是分类变量的ascii码顺序，不一定符合预期
print(ggPie(df) )

#指定因子顺序
df_2=df
df_2$type=factor(df_2$type, levels=c('z1', 'd2', 'n3', 'b4', 'a5', 'c6'))
print( ggPie(df_2) ) #fig2</div>
</div>
<br><br>










<a name="6_4"></a>
<h3 class="tutheader">自定义主题</h3>
<p>图略。输入主题名字，不加括号，就能看到该主题的定义，如: theme_bw。自定义主题就是模仿该函数定义的。</p>
<div class="code notranslate">
	<div style="white-space: pre-wrap;"># 自定义主题
library(ggplot2)
theme_01 = function(..., bg='white'){
  require(grid)
  #theme_classic(...) + #基于预设主题
  theme_bw(...)+
    theme(
          rect=element_rect(fill=bg), #背景色填充
          plot.margin=unit(rep(0.1,4), 'lines'), #图片四周距离
          
          #panel.background=element_rect(fill='transparent', color='black'),#白底黑边
          #panel.border=element_rect(fill='transparent', color='transparent'),
          
          panel.grid=element_blank(), #不要背景网格
          axis.title = element_text(color='black', vjust=0.1), #坐标轴标题也就是变量名
          
          axis.ticks.length = unit(-0.2,"lines"), #坐标刻度向内
          axis.ticks = element_line(color='black'), #坐标轴刻度颜色
          
          #axis.ticks.margin = unit(0.8,"lines"), #`axis.ticks.margin` is deprecated. Please set `margin` property  of `axis.text` instead 
          # unit(c(t, r, b, l), unit)
          axis.text.x = element_text(margin=margin(t=0.8, unit="lines") ), #x轴刻度向上到坐标轴0.8行
          axis.text.y = element_text(margin=margin(r=0.8, unit="lines") ),
          
          ##legend.title=element_blank(), #去掉图例标题
          #legend.key=element_rect(fill='transparent', color='transparent')
          plot.title=element_text(face="bold", hjust = 0.5), #大图标题居中 #size=14,
          
          legend.position="bottom", #图例显示位置
          legend.margin=margin(t = -0.5, unit='line') #图例整体上边距,缩减n行
      )
}

# 使用自定义主题
p=ggplot(mtcars, aes(disp, mpg, color=factor(gear) ))+geom_point();p

p+theme_01()+
  scale_color_hue("gear_DIY")+
  labs(title="mpg ~ disp")</div>
</div>
<br><br>








<a name="6_5"></a>
<h3 class="tutheader">一页多图</h3>
<p>图略: 第一行一个多，第二行2个图。</p>
<div class="code notranslate">
	<div style="white-space: pre-wrap;">#造三个图
library(ggplot2)
a=ggplot(mtcars, aes( factor(gear), mpg, fill=factor(gear) ))+geom_boxplot()
b=a+geom_jitter()
set.seed(1)
c=ggplot(diamonds[sample(1:nrow(diamonds),1000),], aes(carat, price, color=cut))+geom_point(alpha=0.2);

#
library(grid)
outPath="D:\\Temp\\tmp\\"; #设置路径
pdf(paste0(outPath,"pdf/multyPic_onePage.pdf"),width=8,height=8) #设置子文件夹和文件名
#
grid.newpage()
pushViewport(viewport(layout=grid.layout(2,2)) ) #造一个网格，2行2列
#
vplayout=function(x,y){
  viewport(layout.pos.row=x, layout.pos.col=y)
}
print(a,vp=vplayout(1,1:2)) #第1行第1和2列，图a
print(b,vp=vplayout(2,1)) #第2行第1列，图b
print(c,vp=vplayout(2,2)) #第2行第2列，图c
#
dev.off()</div>
</div>
<br>


<p>图略: 可以设置多行多列</p>
<div class="code notranslate">
	<div style="white-space: pre-wrap;">library(gridExtra)
grid.arrange(p1,p2,nrow=1)

grid.arrange(plots[[1]]...plots[[10]],ncol=1,nrow=10)</div>
</div>
<br>
<br>





















<a name="7"></a>
<h2>保存图片</h2>
<pre>
ggsave("diamonds.pdf", width=4, height=4) #units = c("in", "cm", "mm"), 默认是英寸，dpi = 300
</pre>















<a name="8"></a>
<h2>添加文字</h2>
<p>ggplot2在图中添加文字的函数主要是geom_text和annotate。参考 <a href="http://www.cookbook-r.com/Graphs/Fonts/">cookbook-r Fonts</a>, <a href="https://blog.csdn.net/woodcorpse/article/details/106552046">怎样加标签、注释</a>。</p>
<p>fontface：可设置粗体或斜体， “plain”默认普通值, “bold” 粗体、 “italic”斜体。</p>


<h4>怎么防止文字锯齿、模糊?</h4>
<p><a target="_blank" href="https://github.com/tidyverse/ggplot2/issues/4202">This issue at github</a>: 
这种情况出现在只有一个标签、且不用df的时候。构建成df形式就好了。</p>
<img src="images/draw-adv-ggplot2/geom_text.png">
<div class="code notranslate">
	<div style="white-space: pre-wrap;">library(ggplot2) #ggplot 3.2.1
p=ggplot(iris, aes(Sepal.Length, Sepal.Width, color=Species))+
  geom_point(size=0.8)+theme_bw();#p
#(1) add text in picture, 文字不清晰
p+geom_text(aes(x=5, y=4.2, label="setosa"), color='black' )
#(2) add text in picture, 文字清晰
df1=data.frame( x=5, y=4.2, label="setosa" )
p+geom_text(data=df1, aes(x, y, label=label), color='black' )


#原因: 没有指定data，则使用上下文的iris，模糊是因为有150个文字互相覆盖。
#(3)只有一个文字的应该使用 annotate()
p+annotate(geom="text",x=5, y=4.2, label="setosa", color="black")
</div>
</div>
<br>
<br>















<a name="100"></a>
<h2>深入学习 ggplot2 </h2>
<p>微信: <a target="_blank" href="https://mp.weixin.qq.com/s?__biz=MzI5MTcwNjA4NQ==&mid=2247486262&idx=1&sn=d38221a4063d866b1f10f4c9ebab5f88">ggplot2高效实用指南 (可视化脚本、工具、套路、配色)</a></p>

<p>R语言实战 <a target="_blank" href="https://livebook.manning.com/book/r-in-action-second-edition/chapter-19/">Chapter 19. Advanced graphics with ggplot2</a></p>
<p>R cookbook <a target="_blank" href="http://www.cookbook-r.com/Graphs/">Graphs with ggplot2</a></p>
<p>官网: <a target="_blank" href="https://ggplot2.tidyverse.org/">ggplot2 online documentation</a></p>













			</div>
		</div>
		
		<div class="previous-next-links">
			<div class="previous-design-link"><i style="font-size:16px;" class="fa fa-arrow-left" aria-hidden="true"></i> <a href="/R/R-intro.html" rel="pre">R 简介</a> </div>
			<div class="next-design-link"><a href="/R/R-intro.html" rel="next"> R 简介</a> <i style="font-size:16px;" class="fa fa-arrow-right" aria-hidden="true"></i></div>
		</div>
	</div>
</div>







	
	
	
	
	










</div>

</div>

</body>
</html>